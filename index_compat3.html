<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ProdTracker Mobile (Compat)</title>
    <!-- Tailwind CSS via CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM in UMD format -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel standalone to compile JSX on the fly -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase v8 scripts (UMD).  Estas versiones exponen el objeto global `firebase`. -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  </head>
  <body class="bg-slate-200">
    <div id="root"></div>
    <script type="text/babel">
      // Extraemos React hooks del objeto global React
      const { useState, useEffect, useRef } = React;

      // --- ‚öôÔ∏è CONFIGURACI√ìN DE FIREBASE ‚öôÔ∏è ---
      const MY_FIREBASE_CONFIG = {
        apiKey: 'AIzaSyDdVgKwhZl0sTTTLZ7iTmt1r3N2cJLnaDk',
        authDomain: 'prodtraker.firebaseapp.com',
        projectId: 'prodtraker',
        storageBucket: 'prodtraker.appspot.com',
        messagingSenderId: '157613584138',
        appId: '1:157613584138:web:abcdef1234567890abcdef',
        measurementId: 'G-XXXXXXXXXX',
      };
      // Inicializar Firebase (compat)
      const app = firebase.initializeApp(MY_FIREBASE_CONFIG);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const appId = 'prod-tracker-v1';

      // --- DATOS MAESTROS ---
      // Lista por defecto (fallback)
      const DEFAULT_OPERARIOS_LISTA = [
        'Dani Campins',
        'Iara Celeste',
        'ivan Riera',
        'Juan Antonio Jimenez',
        'Jhon Valencia',
        'Carlos Diaz',
        'Jeferson',
        'Jose',
        'Alessandria Lucas',
        'Juan Guzman',
        'Adrian Gonzalez',
        'JavierPerez',
        'Marcelo Curiqueo',
        'Eugenia Berrio',
        'Javier Pastor',
        'Juan Moreno Porras',
        'MAXI Curiqueo',
        'Pau Mir',
        'JAIME REYES',
        'op038',
        'op006',
        'JpNave',
      ];
      const OPERACIONES_LISTA = [
        'Carga de palet',
        'Constituir palets en SD y ubicar palet SD',
        'Control y ubicaci√≥n de PC',
        'Descarga de palet',
        'Desubicaci√≥n de palet SD',
        'Expedici√≥n de PC a Transporte-Retirada',
        'Lay Out',
        'Preparaci√≥n desde SD a PC',
        'Stock Controller',
      ];
      const OBJETIVOS_MAP = {
        'Carga de palet': 22,
        'Constituir palets en SD y ubicar palet SD': 9,
        'Control y ubicaci√≥n de PC': 20,
        'Descarga de palet': 22,
        'Desubicaci√≥n de palet SD': 21,
        'Expedici√≥n de PC a Transporte-Retirada': 6,
        'Preparaci√≥n desde SD a PC': 6,
        'Lay Out': 0,
        'Stock Controller': 0,
      };
      // --- UTILIDAD ---
      const formatTime = (ms) => {
        if (ms < 0) ms = 0;
        const totalSeconds = Math.floor(ms / 1000);
        const h = Math.floor(totalSeconds / 3600)
          .toString()
          .padStart(2, '0');
        const m = Math.floor((totalSeconds % 3600) / 60)
          .toString()
          .padStart(2, '0');
        const s = (totalSeconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
      };

      // --- COMPONENTES ---
      // 1. Vista de Nueva Tarea (Formulario)
      function NewTaskView({ onCancel, onStart, operariosList }) {
        const [selectedOperarios, setSelectedOperarios] = useState([]);
        const [selectedOperaciones, setSelectedOperaciones] = useState([]);
        const [reference, setReference] = useState('');
        const [isDropdownOpen, setDropdownOpen] = useState(false);
        const dropdownRef = useRef(null);
        useEffect(() => {
          const clickOutside = (e) => {
            if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
              setDropdownOpen(false);
            }
          };
          document.addEventListener('mousedown', clickOutside);
          return () => document.removeEventListener('mousedown', clickOutside);
        }, []);
        const toggleOp = (op) => {
          if (selectedOperarios.includes(op)) {
            setSelectedOperarios(selectedOperarios.filter((i) => i !== op));
          } else {
            setSelectedOperarios([...selectedOperarios, op]);
          }
        };
        const toggleTask = (op) => {
          if (selectedOperaciones.includes(op)) {
            setSelectedOperaciones(selectedOperaciones.filter((i) => i !== op));
          } else {
            setSelectedOperaciones([...selectedOperaciones, op]);
          }
        };
        const handleCreate = () => {
          if (selectedOperarios.length === 0 || selectedOperaciones.length === 0) {
            alert('Por favor, selecciona al menos un operario y una actividad.');
            return;
          }
          onStart({
            operarios: selectedOperarios,
            operaciones: selectedOperaciones,
            reference,
          });
        };
        return (
          <div className="h-full flex flex-col bg-slate-50 p-4">
            <div className="flex justify-between items-center mb-4">
              <h2 className="font-bold text-xl text-slate-800">Nueva Asignaci√≥n</h2>
              <button
                onClick={onCancel}
                className="p-2 bg-white rounded-full shadow-sm hover:bg-slate-100"
              >
                <span className="w-5 h-5 inline-block">‚úñ</span>
              </button>
            </div>
            <div className="flex-1 overflow-y-auto space-y-4 pb-20">
              {/* Selector de Operarios */}
              <div
                className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200"
                ref={dropdownRef}
              >
                <label className="block text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-1">
                  <span className="w-3 h-3 inline-block">üë•</span> Personal
                </label>
                <div
                  onClick={() => setDropdownOpen(!isDropdownOpen)}
                  className={`p-3 border rounded-xl flex justify-between items-center cursor-pointer bg-slate-50 select-none transition-colors ${
                    isDropdownOpen
                      ? 'border-blue-400 ring-2 ring-blue-100'
                      : 'border-slate-200'
                  }`}
                >
                  <span
                    className={`text-sm font-medium ${
                      selectedOperarios.length > 0 ? 'text-slate-800' : 'text-slate-400'
                    }`}
                  >
                    {selectedOperarios.length === 0
                      ? 'Seleccionar Operarios...'
                      : `${selectedOperarios.length} seleccionados`}
                  </span>
                  <span
                    className={`w-4 h-4 inline-block text-slate-400 transition-transform duration-200 ${
                      isDropdownOpen ? 'rotate-180' : ''
                    }`}
                  >
                    ‚ñº
                  </span>
                </div>
                {isDropdownOpen && (
                  <div className="mt-2 max-h-60 overflow-y-auto border rounded-xl bg-white shadow-xl z-50 relative">
                    {operariosList.map((op, idx) => (
                      <div
                        key={idx}
                        onClick={() => toggleOp(op)}
                        className={`p-3 flex items-center gap-3 border-b last:border-0 cursor-pointer hover:bg-slate-50 transition-colors ${
                          selectedOperarios.includes(op) ? 'bg-blue-50' : ''
                        }`}
                      >
                        <div
                          className={`w-5 h-5 rounded border flex items-center justify-center transition-all ${
                            selectedOperarios.includes(op)
                              ? 'bg-blue-500 border-blue-500'
                              : 'border-slate-300 bg-white'
                          }`}
                        >
                          {selectedOperarios.includes(op) && (
                            <span className="text-white text-xs">‚úî</span>
                          )}
                        </div>
                        <span
                          className={`text-sm ${
                            selectedOperarios.includes(op)
                              ? 'text-blue-700 font-medium'
                              : 'text-slate-700'
                          }`}
                        >
                          {op}
                        </span>
                      </div>
                    ))}
                  </div>
                )}
                {selectedOperarios.length > 0 && (
                  <div className="flex flex-wrap gap-2 mt-3">
                    {selectedOperarios.map((op) => (
                      <span
                        key={op}
                        className="text-[11px] bg-white border border-blue-200 text-blue-700 px-2 py-1 rounded-full flex items-center gap-1 shadow-sm"
                      >
                        {op}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            toggleOp(op);
                          }}
                          className="hover:bg-blue-100 rounded-full p-0.5"
                        >
                          <span className="text-xs">‚úñ</span>
                        </button>
                      </span>
                    ))}
                  </div>
                )}
              </div>
              {/* Selector de Tareas */}
              <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <label className="block text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-1">
                  <span className="w-3 h-3 inline-block">‚úî</span> Actividad
                </label>
                <div className="space-y-2">
                  {OPERACIONES_LISTA.map((op, idx) => {
                    const isSel = selectedOperaciones.includes(op);
                    return (
                      <button
                        key={idx}
                        onClick={() => toggleTask(op)}
                        className={`w-full text-left p-3 rounded-xl border text-sm font-medium transition-all flex justify-between items-center active:scale-[0.99] ${
                          isSel
                            ? 'border-green-500 bg-green-50 text-green-800 shadow-sm'
                            : 'border-slate-100 bg-white text-slate-600 hover:border-slate-300'
                        }`}
                      >
                        <span className="truncate pr-2">{op}</span>
                        {OBJETIVOS_MAP[op] > 0 && (
                          <span className="text-[10px] bg-white/60 px-2 py-0.5 rounded border border-green-200 whitespace-nowrap">
                            {OBJETIVOS_MAP[op]} u/h
                          </span>
                        )}
                      </button>
                    );
                  })}
                </div>
              </div>
              {/* Referencia */}
              <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">
                  Referencia / Lote (Opcional)
                </label>
                <input
                  value={reference}
                  onChange={(e) => setReference(e.target.value)}
                  placeholder="Ej: Lote #123..."
                  className="w-full p-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                />
              </div>
            </div>
            <div className="mt-auto pt-4 bg-slate-50 border-t border-slate-200">
              <button
                onClick={handleCreate}
                className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"
              >
                <span className="inline-block mr-2">‚ñ∂</span> Comenzar Tarea
              </button>
            </div>
          </div>
        );
      }
      // 2. Vista del Tablero (Dashboard)
      function DashboardView({
        activeTasks,
        now,
        setView,
        cancelTask,
        setFinishingTask,
        setFinishUnits,
      }) {
        return (
          <div className="h-full flex flex-col">
            {/* Barra Superior */}
            <div className="flex justify-between items-center mb-4 px-2 pt-2">
              <div>
                <h2 className="font-bold text-xl text-slate-800">Tablero de Planta</h2>
                <p className="text-xs text-slate-400 font-medium flex items-center gap-1">
                  <span
                    className={`w-2 h-2 rounded-full ${
                      activeTasks.length > 0 ? 'bg-green-500 animate-pulse' : 'bg-slate-300'
                    }`}
                  ></span>
                  {activeTasks.length}{' '}
                  {activeTasks.length === 1 ? 'tarea activa' : 'tareas activas'}
                </p>
              </div>
              <button
                onClick={() => setView('history')}
                className="text-blue-600 text-sm font-bold bg-blue-50 hover:bg-blue-100 px-4 py-2 rounded-xl transition-colors flex items-center gap-2"
              >
                <span className="mr-1">üìú</span> Historial
              </button>
              <button
                onClick={() => setView('operarios')}
                className="text-slate-700 text-sm font-bold bg-white hover:bg-slate-100 px-4 py-2 rounded-xl transition-colors flex items-center gap-2 border border-slate-200"
              >
                <span className="mr-1">üë•</span> Personal
              </button>

            </div>
            {/* Lista de Tareas Activas */}
            <div className="flex-1 overflow-y-auto space-y-3 pb-24 px-2">
              {activeTasks.length === 0 ? (
                <div className="h-64 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50 mx-2">
                  <span className="w-12 h-12 mb-3 opacity-20 text-slate-500 text-5xl">üïí</span>
                  <p className="text-sm font-medium text-slate-500">No hay actividad en planta</p>
                  <button
                    onClick={() => setView('new-task')}
                    className="mt-4 text-blue-600 text-sm font-bold hover:underline"
                  >
                    + Iniciar primera tarea
                  </button>
                </div>
              ) : (
                activeTasks.map((task) => {
                  const elapsed = now - task.startTime;
                  return (
                    <div
                      key={task.id}
                      className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group hover:shadow-md transition-all"
                    >
                      {/* Indicador lateral */}
                      <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-500"></div>
                      <div className="pl-3">
                        <div className="flex justify-between items-start mb-2">
                          <div className="pr-2">
                            <h3 className="font-bold text-slate-800 leading-tight text-sm md:text-base">
                              {task.operaciones.join(', ')}
                            </h3>
                            <div className="flex flex-wrap gap-1 mt-1.5">
                              {task.operarios.map((op, i) => (
                                <span
                                  key={i}
                                  className="text-[10px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded border border-slate-200 truncate max-w-[100px]"
                                >
                                  {op}
                                </span>
                              ))}
                            </div>
                          </div>
                          <div className="text-right shrink-0">
                            <div className="font-mono font-bold text-2xl text-slate-700 tracking-tight tabular-nums">
                              {formatTime(elapsed)}
                            </div>
                            <div className="text-[10px] text-slate-400 font-medium mt-1">
                              Inicio:{' '}
                              {new Date(task.startTime).toLocaleTimeString([], {
                                hour: '2-digit',
                                minute: '2-digit',
                              })}
                            </div>
                          </div>
                        </div>
                        {task.reference && (
                          <div className="mb-3">
                            <span className="text-[10px] font-bold bg-yellow-50 text-yellow-700 px-2 py-0.5 rounded border border-yellow-200 inline-block">
                              REF: {task.reference}
                            </span>
                          </div>
                        )}
                        <div className="flex gap-3 mt-3 border-t pt-3 border-slate-50">
                          <button
                            onClick={() => cancelTask(task.id)}
                            className="p-2.5 text-slate-400 hover:bg-red-50 hover:text-red-500 rounded-xl transition-colors border border-transparent hover:border-red-100"
                            title="Cancelar tarea"
                          >
                            <span>üóë</span>
                          </button>
                          <button
                            onClick={() => {
                              setFinishingTask(task);
                              setFinishUnits('');
                            }}
                            className="flex-1 bg-slate-900 hover:bg-black text-white py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-lg shadow-slate-200 active:scale-[0.98] transition-all"
                          >
                            <span>‚úî</span> Finalizar Tarea
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
            {/* Bot√≥n Flotante Agregar */}
            <div className="absolute bottom-6 right-6 z-30">
              <button
                onClick={() => setView('new-task')}
                className="w-16 h-16 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-xl shadow-blue-400/40 flex items-center justify-center transition-transform hover:scale-105 active:scale-95"
              >
                <span className="text-3xl">‚ûï</span>
              </button>
            </div>
          </div>
        );
      }
      // 3. Modal de Finalizaci√≥n
      function FinishModal({
        finishingTask,
        now,
        finishUnits,
        setFinishUnits,
        setFinishingTask,
        confirmFinishTask,
      }) {
        const currentDuration = now - finishingTask.startTime;
        const hours = currentDuration / 1000 / 3600;
        const currentProd =
          finishUnits && hours > 0 ? (parseInt(finishUnits) / hours).toFixed(1) : '0.0';
        const target = OBJETIVOS_MAP[finishingTask.operaciones[0]];
        const isSuccess = target ? parseFloat(currentProd) >= target : true;
        return (
          <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end md:items-center justify-center p-0 md:p-4">
            <div className="bg-white w-full md:w-[400px] rounded-t-3xl md:rounded-3xl p-6 shadow-2xl relative">
              <div className="flex justify-between items-start mb-6">
                <div>
                  <h3 className="font-bold text-xl text-slate-800">Finalizar Tarea</h3>
                  <p className="text-sm text-slate-500 truncate max-w-[240px]">
                    {finishingTask.operaciones[0]}
                  </p>
                </div>
                <button
                  onClick={() => setFinishingTask(null)}
                  className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors"
                >
                  <span>‚úñ</span>
                </button>
              </div>
              <div className="flex items-center justify-between bg-slate-50 p-4 rounded-2xl mb-6 border border-slate-100">
                <div className="text-center flex-1">
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Tiempo Total</p>
                  <p className="text-2xl font-mono font-bold text-slate-700">{formatTime(currentDuration)}</p>
                </div>
                <div className="w-px h-10 bg-slate-200 mx-2"></div>
                <div className="text-center flex-1">
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Objetivo</p>
                  <p className="text-xl font-bold text-slate-700">
                    {target ? target : '-'}
                    <span className="text-xs font-normal text-slate-400 ml-1">u/h</span>
                  </p>
                </div>
              </div>
              <div className="mb-6">
                <label className="block text-sm font-bold text-slate-700 mb-2 text-center">
                  ¬øCu√°ntas unidades se procesaron?
                </label>
                <input
                  type="number"
                  value={finishUnits}
                  onChange={(e) => setFinishUnits(e.target.value)}
                  autoFocus
                  placeholder="0"
                  className="w-full text-center text-5xl font-bold p-4 rounded-2xl border-2 border-blue-100 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 outline-none text-blue-600 bg-blue-50/30 placeholder-blue-200 transition-all"
                />
              </div>
              {finishUnits && (
                <div
                  className={`mb-6 p-3 rounded-xl flex items-center justify-center gap-2 font-bold text-lg ${
                    isSuccess
                      ? 'bg-green-100 text-green-700 border border-green-200'
                      : 'bg-red-50 text-red-700 border border-red-200'
                  }`}
                >
                  <span>{isSuccess ? '‚úî' : '‚ö†Ô∏è'}</span>
                  {currentProd} u/h
                </div>
              )}
              <button
                onClick={confirmFinishTask}
                disabled={!finishUnits}
                className="w-full py-4 bg-slate-900 disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-xl font-bold text-lg shadow-lg hover:bg-black transition-all active:scale-[0.98]"
              >
                Guardar y Cerrar
              </button>
            </div>
          </div>
        );
      }
      // 4. Vista de Historial
      function HistoryViewComp({ history, setView, downloadCSV }) {
        return (
          <div className="h-full flex flex-col bg-white">
            <div className="p-4 border-b flex justify-between items-center bg-slate-50">
              <h2 className="font-bold text-lg flex items-center gap-2">
                <span>üìú</span> Historial Registrado
              </h2>
              <button
                onClick={() => setView('dashboard')}
                className="text-sm font-bold text-blue-600 bg-white border border-blue-200 px-3 py-1.5 rounded-lg"
              >
                Cerrar
              </button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
              {history.length === 0 ? (
                <div className="text-center text-slate-400 mt-20">
                  <p>No hay registros hoy.</p>
                </div>
              ) : (
                history.map((log) => (
                  <div
                    key={log.id}
                    className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm text-sm hover:border-blue-200 transition-colors"
                  >
                    <div className="flex justify-between mb-1 items-start">
                      <span className="font-bold text-slate-700 truncate max-w-[60%] block">
                        {log.operaciones[0]}
                      </span>
                      <span
                        className={`px-2 py-0.5 rounded text-xs font-bold whitespace-nowrap ${
                          log.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                        }`}
                      >
                        {log.productivity?.toFixed(1)} u/h
                      </span>
                    </div>
                    <div className="text-xs text-slate-500 mb-2">
                      {log.operarios.join(', ')}
                    </div>
                    <div className="flex justify-between text-xs text-slate-400 border-t pt-2 border-slate-50">
                      <span>{log.endTimeString?.split(' ')[1] || 'Reciente'}</span>
                      <span className="font-mono text-slate-500">‚è± {formatTime(log.durationMs)}</span>
                      <span className="font-bold text-slate-600">üì¶ {log.units} uds</span>
                    </div>
                  </div>
                ))
              )}
            </div>
            <div className="p-4 border-t bg-slate-50">
              <button
                onClick={downloadCSV}
                className="w-full py-3 bg-white border border-slate-300 text-slate-700 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-100 active:bg-slate-200 transition-colors shadow-sm"
              >
                <span>‚¨á</span> Descargar Excel (CSV)
              </button>
            </div>
          </div>
        );
      }

      function OperariosView({ operariosList, setOperariosList, setView }) {
        const [newName, setNewName] = useState('');
        const [saving, setSaving] = useState(false);

        const normalize = (s) => (s || '').trim();

        const addOperario = () => {
          const name = normalize(newName);
          if (!name) return;

          const exists = operariosList.some(
            (x) => x.toLowerCase() === name.toLowerCase()
          );
          if (exists) {
            alert('Ese operario ya existe.');
            return;
          }

          setOperariosList((curr) =>
            [...curr, name].sort((a, b) => a.localeCompare(b))
          );
          setNewName('');
        };

        const removeOperario = (name) => {
          if (!confirm(`¬øEliminar "${name}"?`)) return;
          setOperariosList((curr) => curr.filter((x) => x !== name));
        };

        const saveToFirestore = async () => {
          setSaving(true);
          try {
            await db
              .collection('artifacts')
              .doc(appId)
              .collection('config')
              .doc('app')
              .set(
                {
                  operarios: operariosList,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                },
                { merge: true }
              );
            alert('Operarios guardados.');
          } catch (e) {
            console.error(e);
            alert('No se pudo guardar. Revisa conexi√≥n/permisos.');
          } finally {
            setSaving(false);
          }
        };

        return (
          <div className="h-full flex flex-col bg-white">
            <div className="p-4 border-b flex justify-between items-center bg-slate-50">
              <h2 className="font-bold text-lg flex items-center gap-2">
                <span>üë•</span> Personal (Operarios)
              </h2>
              <button
                onClick={() => setView('dashboard')}
                className="text-sm font-bold text-blue-600 bg-white border border-blue-200 px-3 py-1.5 rounded-lg"
              >
                Cerrar
              </button>
            </div>

            <div className="p-4 space-y-3">
              <div className="bg-slate-50 border border-slate-200 rounded-2xl p-3">
                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">
                  A√±adir operario
                </label>
                <div className="flex gap-2">
                  <input
                    value={newName}
                    onChange={(e) => setNewName(e.target.value)}
                    placeholder="Nombre / c√≥digo (ej: op123)"
                    className="flex-1 p-3 bg-white rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-200"
                  />
                  <button
                    onClick={addOperario}
                    className="px-4 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700"
                  >
                    + A√±adir
                  </button>
                </div>
              </div>

              <div className="text-xs text-slate-500">
                Total: <b>{operariosList.length}</b>
              </div>

              <div className="max-h-[55vh] overflow-y-auto border rounded-2xl">
                {operariosList.map((name) => (
                  <div
                    key={name}
                    className="flex items-center justify-between p-3 border-b last:border-0"
                  >
                    <span className="text-sm font-medium text-slate-800">
                      {name}
                    </span>
                    <button
                      onClick={() => removeOperario(name)}
                      className="px-3 py-1.5 rounded-lg text-sm font-bold bg-red-50 text-red-700 hover:bg-red-100 border border-red-200"
                    >
                      Eliminar
                    </button>
                  </div>
                ))}
              </div>
            </div>

            <div className="mt-auto p-4 border-t bg-slate-50">
              <button
                onClick={saveToFirestore}
                disabled={saving}
                className="w-full py-3 bg-slate-900 disabled:bg-slate-400 text-white rounded-xl font-bold"
              >
                {saving ? 'Guardando...' : 'Guardar en la nube (Firestore)'}
              </button>
            </div>
          </div>
        );
      }

      // --- APP PRINCIPAL ---
      function App() {
        const [user, setUser] = useState(null);
        const [view, setView] = useState('dashboard');
        const [operariosList, setOperariosList] = useState(() => {
          try {
            const saved = localStorage.getItem('prodtracker_operarios_list');
            return saved ? JSON.parse(saved) : DEFAULT_OPERARIOS_LISTA;
          } catch (e) {
            return DEFAULT_OPERARIOS_LISTA;
          }
        });
        const [activeTasks, setActiveTasks] = useState(() => {
          try {
            const saved = localStorage.getItem('prodtracker_active_tasks');
            return saved ? JSON.parse(saved) : [];
          } catch (e) {
            return [];
          }
        });
        const [finishingTask, setFinishingTask] = useState(null);
        const [finishUnits, setFinishUnits] = useState('');
        const [history, setHistory] = useState([]);
        const [now, setNow] = useState(Date.now());
        // Auth init
        useEffect(() => {
          auth.signInAnonymously().catch((err) => {
            console.error('Auth error', err);
          });
          const unsub = auth.onAuthStateChanged((u) => setUser(u));
          return () => unsub();
        }, []);
        // Load history
        useEffect(() => {
          if (!user) return;
          const ref = db
            .collection('artifacts')
            .doc(appId)
            .collection('users')
            .doc(user.uid)
            .collection('prod_tracker_logs')
            .orderBy('timestamp', 'desc');
          const unsub = ref.onSnapshot((snapshot) => {
            const docs = [];
            snapshot.forEach((doc) => docs.push({ id: doc.id, ...doc.data() }));
            setHistory(docs);
          });
          return () => unsub();
        }, [user]);
        // Load operarios config (shared)
        useEffect(() => {
          if (!user) return;

          const ref = db
            .collection('artifacts')
            .doc(appId)
            .collection('config')
            .doc('app');

          const unsub = ref.onSnapshot((doc) => {
            const data = doc.data();
            if (
              data?.operarios &&
              Array.isArray(data.operarios) &&
              data.operarios.length > 0
            ) {
              setOperariosList(data.operarios);
            }
          });

          return () => unsub();
        }, [user]);

        // Save active tasks to localStorage
        useEffect(() => {
          localStorage.setItem('prodtracker_active_tasks', JSON.stringify(activeTasks));
        }, [activeTasks]);
        // Save operarios list to localStorage
        useEffect(() => {
          localStorage.setItem(
            'prodtracker_operarios_list',
            JSON.stringify(operariosList)
          );
        }, [operariosList]);
        // Update time every second
        useEffect(() => {
          const id = setInterval(() => setNow(Date.now()), 1000);
          return () => clearInterval(id);
        }, []);
        // Logic functions
        const addNewTask = (taskData) => {
          const newTask = {
            id: Date.now().toString(),
            ...taskData,
            startTime: Date.now(),
          };
          setActiveTasks([newTask, ...activeTasks]);
          setView('dashboard');
        };
        const confirmFinishTask = async () => {
          // Si no hay tarea a finalizar, salimos
          if (!finishingTask) return;
          // Registrar tiempos y productividad
          const endTime = Date.now();
          const durationMs = endTime - finishingTask.startTime;
          const durationHours = durationMs / 1000 / 3600;
          const units = parseInt(finishUnits || 0);
          const prod = durationHours > 0 ? units / durationHours : 0;
          const mainOp = finishingTask.operaciones[0];
          const target = OBJETIVOS_MAP[mainOp] || 0;
          const logEntry = {
            operarios: finishingTask.operarios,
            operaciones: finishingTask.operaciones,
            reference: finishingTask.reference || 'N/A',
            startTimeString: new Date(finishingTask.startTime).toLocaleString(),
            endTimeString: new Date(endTime).toLocaleString(),
            durationMs: durationMs,
            units: units,
            productivity: prod,
            target: target,
            success: target > 0 ? prod >= target : true,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          };
          // Cerrar la tarea en la UI inmediatamente
          setActiveTasks(activeTasks.filter((t) => t.id !== finishingTask.id));
          setFinishingTask(null);
          setFinishUnits('');

          // A√±adir el log al historial local de inmediato para que aparezca en la vista de Historial
          // Generamos un ID temporal basado en la hora actual
          const tempId = Date.now().toString();
          setHistory((curr) => [{ id: tempId, ...logEntry }, ...curr]);

          // Si hay usuario autenticado intentamos guardar en Firestore
          if (user) {
            try {
              await db
                .collection('artifacts')
                .doc(appId)
                .collection('users')
                .doc(user.uid)
                .collection('prod_tracker_logs')
                .add(logEntry);
            } catch (err) {
              console.error('Error saving', err);
              alert('Error de conexi√≥n. Intente guardar de nuevo.');
            }
          }
        };
        const cancelTask = (taskId) => {
          if (
            confirm('¬øSeguro que quieres borrar esta tarea sin guardar datos?')
          ) {
            setActiveTasks(activeTasks.filter((t) => t.id !== taskId));
          }
        };
        const downloadCSV = () => {
          if (history.length === 0) return;
          const headers = [
            'Fecha',
            'Inicio',
            'Fin',
            'Ref/Lote',
            'Operarios',
            'Tareas',
            'Duraci√≥n',
            'Unidades',
            'Prod. Real',
            'Objetivo',
            'Cumple',
          ];
          const rows = history.map((log) => {
            const start = log.startTimeString || '';
            const end = log.endTimeString || '';
            return [
              start.split(',')[0],
              start.split(',')[1]?.trim(),
              end.split(',')[1]?.trim(),
              `"${log.reference || ''}"`,
              `"${log.operarios.join(' | ')}"`,
              `"${log.operaciones.join(' | ')}"`,
              formatTime(log.durationMs),
              log.units,
              (log.productivity || 0).toFixed(2).replace('.', ','),
              log.target,
              log.success ? 'SI' : 'NO',
            ].join(';');
          });
          const csvContent =
            'data:text/csv;charset=utf-8,' +
            [headers.join(';'), ...rows].join('\n');
          const link = document.createElement('a');
          link.setAttribute('href', encodeURI(csvContent));
          link.setAttribute('download', 'ProdTracker_Data.csv');
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };
        return (
          <div className="min-h-screen bg-slate-200 flex items-center justify-center p-0 md:p-4 font-sans">
            <div className="w-full md:max-w-md bg-white h-[100vh] md:h-[850px] md:rounded-[2rem] shadow-2xl overflow-hidden flex flex-col relative border-x md:border border-slate-200">
              {/* Top Bar */}
              <div className="bg-slate-900 p-4 text-white shrink-0 flex justify-between items-center z-20 shadow-md">
                <div className="flex items-center gap-2.5">
                  <div className="bg-blue-600 p-1.5 rounded-lg shadow-lg shadow-blue-900/50">
                    <span>üìä</span>
                  </div>
                  <div>
                    <h1 className="font-bold text-sm leading-tight tracking-wide">ProdTracker</h1>
                    <p className="text-[10px] text-slate-400 font-mono">v2.0 Multi-Sesi√≥n</p>
                  </div>
                </div>
                <div
                  className={`flex items-center gap-2 px-2 py-1 rounded-full border ${
                    user ? 'bg-green-900/30 border-green-800' : 'bg-red-900/30 border-red-800'
                  }`}
                >
                  <div className={`w-2 h-2 rounded-full ${user ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                  <span className="text-[10px] font-bold text-slate-300 uppercase">{user ? 'ONLINE' : 'OFFLINE'}</span>
                </div>
              </div>
              {/* Contenido Principal */}
              <div className="flex-1 overflow-hidden relative bg-slate-100">
                {view === 'dashboard' && (
                  <DashboardView
                    activeTasks={activeTasks}
                    now={now}
                    setView={setView}
                    cancelTask={cancelTask}
                    setFinishingTask={setFinishingTask}
                    setFinishUnits={setFinishUnits}
                  />
                )}
                {view === 'new-task' && (
                  <NewTaskView onCancel={() => setView('dashboard')} onStart={addNewTask} operariosList={operariosList} />
                )}
                {view === 'operarios' && (
                  <OperariosView
                    operariosList={operariosList}
                    setOperariosList={setOperariosList}
                    setView={setView}
                  />
                )}
                {view === 'history' && (
                  <HistoryViewComp history={history} setView={setView} downloadCSV={downloadCSV} />
                )}
              </div>
              {finishingTask && (
                <FinishModal
                  finishingTask={finishingTask}
                  now={now}
                  finishUnits={finishUnits}
                  setFinishUnits={setFinishUnits}
                  setFinishingTask={setFinishingTask}
                  confirmFinishTask={confirmFinishTask}
                />
              )}
            </div>
          </div>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>